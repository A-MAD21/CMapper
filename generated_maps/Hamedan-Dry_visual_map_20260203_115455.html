<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>CMapper - Hamedan - Dry visual map</title>
  <style>
    html, body { height: 100%; margin: 0; font-family: Arial, sans-serif; background: #0c1b2a; color: #e8edf2; }
    #topbar { padding: 12px 16px; border-bottom: 1px solid #1e3147; background: #13263b; }
    #network { height: calc(100% - 54px); background: radial-gradient(circle at 20% 20%, #123, #0b1826); position: relative; overflow: hidden; }
    .muted { color: #9fb3c8; font-size: 13px; }
    .node-label { fill: #e8edf2; font-size: 12px; pointer-events: none; }
    .node-circle { stroke: #c1ddff; stroke-width: 1; }
    .node-circle.selected { stroke: #ffffff; stroke-width: 2; }
    .node-icon { pointer-events: none; }
    .edge { stroke: #5c7ea8; stroke-width: 1.3; opacity: 0.7; }
    .tooltip {
      position: absolute;
      background: rgba(10, 20, 35, 0.9);
      color: #e8edf2;
      padding: 6px 10px;
      border: 1px solid #234;
      border-radius: 6px;
      pointer-events: none;
      font-size: 12px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="topbar">
    <div><b>Site:</b> Hamedan - Dry <span class="muted">(83 devices, 19 links)</span></div>
    <div class="muted">Generated 2026-02-03T11:54:55</div>
  </div>
  <div id="network">
    <svg id="svg" width="100%" height="100%"></svg>
    <div id="tooltip" class="tooltip"></div>
  </div>
  <script>
    const nodes = [{"id": "dev_a97ee31f", "label": "SWC2.OKCO.ir", "title": "10.192.111.3 | switch | cisco WS-C2960S-48FPS-L", "icon": "/static/icons/map/switch.png", "type": "switch"}, {"id": "dev_5a29f237", "label": "SWC1", "title": "10.192.111.13 | switch | cisco WS-C2960S-24PS-L", "icon": "/static/icons/map/switch.png", "type": "switch"}, {"id": "dev_d710fab8", "label": "SWC4.OKCO.ir", "title": "10.192.111.5 | switch | cisco WS-C2960S-48FPS-L", "icon": "/static/icons/map/switch.png", "type": "switch"}, {"id": "dev_f7df95a3", "label": "SW1-soole3-dry-Hamedan.OKCO.ir", "title": "10.192.111.15 | switch | cisco WS-C2960S-24PS-L", "icon": "/static/icons/map/switch.png", "type": "switch"}, {"id": "dev_8a02ff98", "label": "SWC3.OKCO.ir", "title": "10.192.111.4 | switch | cisco WS-C2960S-48FPS-L", "icon": "/static/icons/map/switch.png", "type": "switch"}, {"id": "dev_f07eac5a", "label": "SWC6", "title": "10.192.111.7 | switch | cisco WS-C2960+24LC-L", "icon": "/static/icons/map/switch.png", "type": "switch"}, {"id": "dev_5052b99a", "label": "SWMAIN-hamedandry.OKCO.ir", "title": "10.192.111.14 | switch | cisco WS-C2960S-24PS-L", "icon": "/static/icons/map/switch.png", "type": "switch"}, {"id": "dev_2d0ac826", "label": "SWC7.OKCO.ir", "title": "10.192.111.11 | switch | cisco WS-C2960+24LC-L", "icon": "/static/icons/map/switch.png", "type": "switch"}, {"id": "dev_5c64e3e1", "label": "SWC5", "title": "10.192.111.5 | switch | cisco WS-C2960S-24PS-L", "icon": "/static/icons/map/switch.png", "type": "switch"}, {"id": "dev_mac_24e9b3afb1d0_hamedan___dry", "label": "Router", "title": "10.192.111.1 | router | 2911", "icon": "/static/icons/map/router.png", "type": "router"}, {"id": "dev_mac_c40acbc9bdc0_hamedan___dry", "label": "SW-Rahro-Sardkhaneh-DR-Hamedan.OKCO.ir", "title": "10.192.111.16 | switch | cisco WS-C2960S-24PS-L", "icon": "/static/icons/map/switch.png", "type": "switch"}, {"id": "dev_mac_7483c239bcce_hamedan___dry", "label": "1LRSW1-soole3-15Port01", "title": "10.192.111.20 | ap | UAP-AC-LR", "icon": "/static/icons/map/ap.png", "type": "ap"}, {"id": "dev_mac_e063da337937_hamedan___dry", "label": "3-PROSW-Rahro-Sardkha16Port02", "title": "10.192.111.22 | ap | UAP-AC-Pro-Gen2", "icon": "/static/icons/map/ap.png", "type": "ap"}, {"id": "dev_mac_18e829cc0937_hamedan___dry", "label": "4LRSW-Rahro-Sardkha16Port05", "title": "10.192.111.23 | ap | UAP-AC-LR", "icon": "/static/icons/map/ap.png", "type": "ap"}, {"id": "dev_mac_e063da33551a_hamedan___dry", "label": "6-ProSW-Rahro-Sardkha16Port04", "title": "10.192.111.25 | ap | UAP-AC-Pro-Gen2", "icon": "/static/icons/map/ap.png", "type": "ap"}, {"id": "dev_mac_e063dab0cf9e_hamedan___dry", "label": "7-ProSW-Rahro-Sardkha16Port01", "title": "10.192.111.26 | ap | UAP-AC-Pro-Gen2", "icon": "/static/icons/map/ap.png", "type": "ap"}, {"id": "dev_mac_e063da3373f4_hamedan___dry", "label": "8-ProSW-Rahro-Sardkha16Port03", "title": "10.192.111.27 | ap | UAP-AC-Pro-Gen2", "icon": "/static/icons/map/ap.png", "type": "ap"}, {"id": "dev_mac_18e8291021b4_hamedan___dry", "label": "9-MSWc711PortFa04", "title": "10.192.111.28 | ap | UAP-AC-Mesh-Pro", "icon": "/static/icons/map/ap.png", "type": "ap"}, {"id": "dev_mac_e063da33764a_hamedan___dry", "label": "2-PROSW1-soole3-15Port02", "title": "10.192.111.21 | ap | UAP-AC-Pro-Gen2", "icon": "/static/icons/map/ap.png", "type": "ap"}];
    const edges = [{"from": "dev_a97ee31f", "to": "dev_a97ee31f", "label": "GigabitEthernet1/0/48", "protocol": "CDP", "width": 8.0}, {"from": "dev_a97ee31f", "to": "dev_5a29f237", "label": "GigabitEthernet1/0/48", "protocol": "CDP", "width": 8.0}, {"from": "dev_5a29f237", "to": "dev_d710fab8", "label": "GigabitEthernet1/0/48", "protocol": "CDP", "width": 8.0}, {"from": "dev_5a29f237", "to": "dev_f7df95a3", "label": "GigabitEthernet1/0/46", "protocol": "CDP", "width": 8.0}, {"from": "dev_d710fab8", "to": "dev_8a02ff98", "label": "GigabitEthernet2/0/45", "protocol": "CDP", "width": 8.0}, {"from": "dev_f07eac5a", "to": "dev_5052b99a", "label": "GigabitEthernet1/0/48", "protocol": "CDP", "width": 8.0}, {"from": "dev_f07eac5a", "to": "dev_2d0ac826", "label": "GigabitEthernet1/0/46", "protocol": "MANUAL", "width": 8.0}, {"from": "dev_5052b99a", "to": "dev_f7df95a3", "label": "unknown", "protocol": "MANUAL", "width": 8.0}, {"from": "dev_5c64e3e1", "to": "dev_f7df95a3", "label": "GigabitEthernet1/0/48", "protocol": "CDP", "width": 8.0}, {"from": "dev_mac_24e9b3afb1d0_hamedan___dry", "to": "dev_5052b99a", "label": "unknown", "protocol": "MANUAL", "width": 8.0}, {"from": "dev_mac_c40acbc9bdc0_hamedan___dry", "to": "dev_5052b99a", "label": "unknown", "protocol": "MANUAL", "width": 8.0}, {"from": "dev_mac_7483c239bcce_hamedan___dry", "to": "dev_f7df95a3", "label": "eth0", "protocol": "CDP", "width": 1.3}, {"from": "dev_mac_e063da337937_hamedan___dry", "to": "dev_mac_c40acbc9bdc0_hamedan___dry", "label": "eth0", "protocol": "CDP", "width": 1.3}, {"from": "dev_mac_18e829cc0937_hamedan___dry", "to": "dev_mac_c40acbc9bdc0_hamedan___dry", "label": "eth0", "protocol": "CDP", "width": 1.3}, {"from": "dev_mac_e063da33551a_hamedan___dry", "to": "dev_mac_c40acbc9bdc0_hamedan___dry", "label": "eth0", "protocol": "CDP", "width": 1.3}, {"from": "dev_mac_e063dab0cf9e_hamedan___dry", "to": "dev_mac_c40acbc9bdc0_hamedan___dry", "label": "eth0", "protocol": "CDP", "width": 1.3}, {"from": "dev_mac_e063da3373f4_hamedan___dry", "to": "dev_mac_c40acbc9bdc0_hamedan___dry", "label": "eth0", "protocol": "CDP", "width": 1.3}, {"from": "dev_mac_18e8291021b4_hamedan___dry", "to": "dev_2d0ac826", "label": "eth0", "protocol": "CDP", "width": 1.3}, {"from": "dev_mac_e063da33764a_hamedan___dry", "to": "dev_f7df95a3", "label": "eth0", "protocol": "CDP", "width": 1.3}];
    const basePositions = {"dev_a97ee31f": {"x": 1368.0, "y": 760.0}, "dev_5a29f237": {"x": 1335.056882953986, "y": 957.4172772764475}, "dev_d710fab8": {"x": 1239.7974297130072, "y": 1133.441329315318}, "dev_f7df95a3": {"x": 1092.5444801384356, "y": 1268.9972187836174}, "dev_8a02ff98": {"x": 909.255176181606, "y": 1349.3953616911128}, "dev_f07eac5a": {"x": 709.791757952822, "y": 1365.9233717480552}, "dev_5052b99a": {"x": 515.7691818109946, "y": 1316.7901826062748}, "dev_2d0ac826": {"x": 348.2128044515496, "y": 1207.3201376892641}, "dev_5c64e3e1": {"x": 225.27995926645474, "y": 1049.3760149665409}, "dev_mac_24e9b3afb1d0_hamedan___dry": {"x": 160.2923275311448, "y": 860.0735108906863}, "dev_mac_c40acbc9bdc0_hamedan___dry": {"x": 160.2923275311448, "y": 659.9264891093138}, "dev_mac_7483c239bcce_hamedan___dry": {"x": 225.2799592664545, "y": 470.6239850334596}, "dev_mac_e063da337937_hamedan___dry": {"x": 348.2128044515494, "y": 312.679862310736}, "dev_mac_18e829cc0937_hamedan___dry": {"x": 515.7691818109948, "y": 203.20981739372496}, "dev_mac_e063da33551a_hamedan___dry": {"x": 709.7917579528217, "y": 154.07662825194473}, "dev_mac_e063dab0cf9e_hamedan___dry": {"x": 909.2551761816056, "y": 170.60463830888705}, "dev_mac_e063da3373f4_hamedan___dry": {"x": 1092.5444801384353, "y": 251.00278121638252}, "dev_mac_18e8291021b4_hamedan___dry": {"x": 1239.7974297130074, "y": 386.5586706846822}, "dev_mac_e063da33764a_hamedan___dry": {"x": 1335.056882953986, "y": 562.5827227235523}};
    const typeColors = {
      router: '#F9A8A8',
      switch: '#A5D8FF',
      unknown: '#1f8ef1',
      ap: '#FFFFFF',
      firewall: '#D8B4FE',
      nvr: '#A7F3D0',
      server: '#FBCFE8'
    };

    const svg = document.getElementById('svg');
    const tooltip = document.getElementById('tooltip');

    // Layout and physics parameters
    const params = {
      repulsion: 18000,
      spring: 0.015,
      restLength: 180,
      damping: 0.85,
      maxStep: 12
    };

    let nodePos = Object.fromEntries(nodes.map(n => [n.id, { ...basePositions[n.id] }]));
    let velocity = Object.fromEntries(nodes.map(n => [n.id, { x: 0, y: 0 }]));
    let draggingId = null;
    let selectedId = null;
    let panning = false;
    let lastPan = null;
    const transform = { x: 0, y: 0, scale: 1 };

    function resize() {
      const rect = svg.getBoundingClientRect();
      svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
      // Center initial positions
      Object.values(nodePos).forEach(p => {
        if (!p._shifted) {
          p.x += rect.width / 2;
          p.y += rect.height / 2;
          p._shifted = true;
        }
      });
    }

    function applyForces() {
      // Repulsion
      for (let i = 0; i < nodes.length; i++) {
        for (let j = i + 1; j < nodes.length; j++) {
          const a = nodePos[nodes[i].id];
          const b = nodePos[nodes[j].id];
          let dx = a.x - b.x;
          let dy = a.y - b.y;
          const dist2 = Math.max(dx*dx + dy*dy, 40); // avoid div/0
          const force = params.repulsion / dist2;
          const invDist = 1 / Math.sqrt(dist2);
          dx *= invDist; dy *= invDist;
          velocity[nodes[i].id].x += dx * force;
          velocity[nodes[i].id].y += dy * force;
          velocity[nodes[j].id].x -= dx * force;
          velocity[nodes[j].id].y -= dy * force;
        }
      }

      // Springs
      edges.forEach(e => {
        const a = nodePos[e.from];
        const b = nodePos[e.to];
        let dx = b.x - a.x;
        let dy = b.y - a.y;
        const dist = Math.max(Math.sqrt(dx*dx + dy*dy), 1);
        const force = params.spring * (dist - params.restLength);
        const normX = dx / dist;
        const normY = dy / dist;
        velocity[e.from].x += force * normX;
        velocity[e.from].y += force * normY;
        velocity[e.to].x -= force * normX;
        velocity[e.to].y -= force * normY;
      });

      // Integrate
      const rect = svg.getBoundingClientRect();
      const minX = 30, minY = 30, maxX = rect.width - 30, maxY = rect.height - 30;

      nodes.forEach(n => {
        if (draggingId === n.id) return; // don't move while dragging
        const v = velocity[n.id];
        v.x *= params.damping;
        v.y *= params.damping;
        v.x = Math.max(Math.min(v.x, params.maxStep), -params.maxStep);
        v.y = Math.max(Math.min(v.y, params.maxStep), -params.maxStep);
        const p = nodePos[n.id];
        p.x = Math.min(Math.max(minX, p.x + v.x), maxX);
        p.y = Math.min(Math.max(minY, p.y + v.y), maxY);
      });
    }

    function draw() {
      svg.innerHTML = '';
      const root = document.createElementNS('http://www.w3.org/2000/svg', 'g');
      root.setAttribute('transform', `translate(${transform.x}, ${transform.y}) scale(${transform.scale})`);

      // Draw edges
      edges.forEach(e => {
        const a = nodePos[e.from];
        const b = nodePos[e.to];
        if (!a || !b) return;
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', a.x);
        line.setAttribute('y1', a.y);
        line.setAttribute('x2', b.x);
        line.setAttribute('y2', b.y);
        line.setAttribute('class', 'edge');
        line.setAttribute('stroke-width', e.width || 1.3);
        root.appendChild(line);
      });

      // Draw nodes
      nodes.forEach(n => {
        const p = nodePos[n.id];
        if (!p) return;

        const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        g.setAttribute('cursor', 'pointer');
        g.addEventListener('mousemove', (evt) => {
          tooltip.style.display = 'block';
          tooltip.style.left = `${evt.clientX + 10}px`;
          tooltip.style.top = `${evt.clientY + 10}px`;
          tooltip.innerHTML = `<b>${n.label}</b><br/>${n.title || 'No details'}`;
        });
        g.addEventListener('mouseleave', () => {
          tooltip.style.display = 'none';
        });
        g.addEventListener('mousedown', (evt) => {
          selectedId = n.id;
          if (window.parent && window.parent !== window) {
            window.parent.postMessage({ type: 'cmapp:select', deviceId: n.id }, '*');
          }
          draggingId = n.id;
          tooltip.style.display = 'none';
          evt.preventDefault();
          evt.stopPropagation();
        });

        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', p.x);
        circle.setAttribute('cy', p.y);
        circle.setAttribute('r', 14);
        circle.setAttribute('class', 'node-circle' + (n.id === selectedId ? ' selected' : ''));
        const dtype = (n.type || '').toLowerCase();
        const baseColor = typeColors[dtype] || typeColors.unknown;
        circle.setAttribute('fill', n.id === selectedId ? '#f5b642' : baseColor);
        g.appendChild(circle);

        if (n.icon) {
          const img = document.createElementNS('http://www.w3.org/2000/svg', 'image');
          img.setAttribute('href', n.icon);
          img.setAttribute('x', p.x - 9);
          img.setAttribute('y', p.y - 9);
          img.setAttribute('width', 18);
          img.setAttribute('height', 18);
          img.setAttribute('class', 'node-icon');
          g.appendChild(img);
        }

        const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        text.setAttribute('x', p.x);
        text.setAttribute('y', p.y + 26);
        text.setAttribute('class', 'node-label');
        text.setAttribute('text-anchor', 'middle');
        text.textContent = n.label;
        g.appendChild(text);

        root.appendChild(g);
      });

      svg.appendChild(root);
    }

    function onMouseMove(evt) {
      if (draggingId) {
        const p = nodePos[draggingId];
        const world = toWorld(evt);
        p.x = world.x;
        p.y = world.y;
        velocity[draggingId].x = 0;
        velocity[draggingId].y = 0;
      } else if (panning && lastPan) {
        transform.x += evt.clientX - lastPan.x;
        transform.y += evt.clientY - lastPan.y;
        lastPan = { x: evt.clientX, y: evt.clientY };
      }
    }
    function onMouseUp() { draggingId = null; panning = false; }

    // Zoom/pan controls
    svg.addEventListener('wheel', (evt) => {
      evt.preventDefault();
      const scaleDelta = evt.deltaY < 0 ? 1.1 : 0.9;
      const mouse = toWorld(evt);
      transform.scale = Math.min(3, Math.max(0.4, transform.scale * scaleDelta));
      transform.x = evt.clientX - mouse.x * transform.scale;
      transform.y = evt.clientY - mouse.y * transform.scale;
    }, { passive: false });

    svg.addEventListener('mousedown', (evt) => {
      if (evt.target.tagName === 'circle' || evt.target.tagName === 'text') return;
      panning = true;
      lastPan = { x: evt.clientX, y: evt.clientY };
    });

    window.addEventListener('resize', resize);
    window.addEventListener('mousemove', onMouseMove);
    window.addEventListener('mouseup', onMouseUp);
    window.addEventListener('message', (evt) => {
      const data = evt.data || {};
      if (data.type === 'cmapp:select' && data.deviceId) {
        selectedId = data.deviceId;
      }
    });

    resize();
    function loop() {
      applyForces();
      draw();
      requestAnimationFrame(loop);
    }
    loop();

    function toWorld(evt) {
      return {
        x: (evt.clientX - transform.x) / transform.scale,
        y: (evt.clientY - transform.y) / transform.scale
      };
    }
  </script>
</body>
</html>
